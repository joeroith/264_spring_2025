<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>MSCS 264: Data Science 2 - Simulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">MSCS 264: Data Science 2</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tech-notes" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Tech Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tech-notes">    
        <li>
    <a class="dropdown-item" href="./tech_setup.html" rel="" target="">
 <span class="dropdown-text">Tech Setup</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./why_quarto.html" rel="" target="">
 <span class="dropdown-text">Why Quarto?</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./github_website.html" rel="" target="">
 <span class="dropdown-text">Using GitHub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./github_links.html" rel="" target="">
 <span class="dropdown-text">GitHub Links</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-activities" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Activities</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-activities">    
        <li>
    <a class="dropdown-item" href="./01_review164.html" rel="" target="">
 <span class="dropdown-text">Review of Data Science 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02_maps_part1.html" rel="" target="">
 <span class="dropdown-text">Creating informative maps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03_maps_part2.html" rel="" target="">
 <span class="dropdown-text">Working with geospatial data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04_functions.html" rel="" target="">
 <span class="dropdown-text">Functions and tidy evaluation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05_data_types.html" rel="" target="">
 <span class="dropdown-text">Data types</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06_iteration.html" rel="" target="">
 <span class="dropdown-text">Iteration</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./07_simulation.html" rel="" target="">
 <span class="dropdown-text">Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./MDSR_Ch13_simulation.html" rel="" target="">
 <span class="dropdown-text">MDSR Ch 13: Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./08_strings_part1.html" rel="" target="">
 <span class="dropdown-text">Strings: Pre-class Video</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./09_strings_part2.html" rel="" target="">
 <span class="dropdown-text">Strings: In-class Exercises</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./10_strings_part3.html" rel="" target="">
 <span class="dropdown-text">Strings: Extra Practice</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./11_SQL.html" rel="" target="">
 <span class="dropdown-text">MDSR Ch 15: Database querying using SQL</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./12_webscraping.html" rel="" target="">
 <span class="dropdown-text">Web scraping in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./13_first_shiny_instructions.html" rel="" target="">
 <span class="dropdown-text">First Shiny instructions</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projects" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Projects</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-projects">    
        <li>
    <a class="dropdown-item" href="./miniproject1.html" rel="" target="">
 <span class="dropdown-text">Mini-Project 1: Maps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./miniproject2.html" rel="" target="">
 <span class="dropdown-text">Mini-Project 2: Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./miniproject3.html" rel="" target="">
 <span class="dropdown-text">Mini-Project 3: Strings and Regular Expressions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./miniproject4.html" rel="" target="">
 <span class="dropdown-text">Mini-Project 4: SQL</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./finalproject.html" rel="" target="">
 <span class="dropdown-text">Final Project: Shiny App</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./rtipoftheday.html" rel="" target="">
 <span class="menu-text">R Tip of the Day</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07_simulation.html">Simulation</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_review164.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Review of Data Science 1</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_maps_part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Creating informative maps</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_maps_part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Working with geospatial data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Functions and tidy evaluation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_data_types.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data types</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_iteration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Iteration</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_simulation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./MDSR_Ch13_simulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MDSR Ch 13: Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_strings_part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Strings: Pre-class Video</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_strings_part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Strings: In-class Exercises</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_strings_part3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Strings: Extra Practice</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_SQL.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MDSR Ch 15: Database querying using SQL</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_webscraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Web scraping in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_first_shiny_instructions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">First Shiny instructions</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#simulation" id="toc-simulation" class="nav-link active" data-scroll-target="#simulation">Simulation</a>
  <ul class="collapse">
  <li><a href="#simulating-behavior-under-a-null-hypothesis" id="toc-simulating-behavior-under-a-null-hypothesis" class="nav-link" data-scroll-target="#simulating-behavior-under-a-null-hypothesis">Simulating behavior under a null hypothesis</a>
  <ul class="collapse">
  <li><a href="#on-your-own" id="toc-on-your-own" class="nav-link" data-scroll-target="#on-your-own">On Your Own</a></li>
  </ul></li>
  <li><a href="#evaluate-conditions-for-a-statistical-test" id="toc-evaluate-conditions-for-a-statistical-test" class="nav-link" data-scroll-target="#evaluate-conditions-for-a-statistical-test">Evaluate conditions for a statistical test</a>
  <ul class="collapse">
  <li><a href="#on-your-own-1" id="toc-on-your-own-1" class="nav-link" data-scroll-target="#on-your-own-1">On Your Own</a></li>
  </ul></li>
  <li><a href="#find-the-power-of-a-statistical-test" id="toc-find-the-power-of-a-statistical-test" class="nav-link" data-scroll-target="#find-the-power-of-a-statistical-test">Find the power of a statistical test</a>
  <ul class="collapse">
  <li><a href="#on-your-own-2" id="toc-on-your-own-2" class="nav-link" data-scroll-target="#on-your-own-2">On Your Own</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Simulation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>You can download this .qmd file from <a href="https://github.com/proback/264_fall_2024/blob/main/07_simulation.qmd">here</a>. Just hit the Download Raw File button.</p>
<p>This leans on parts of MDSR Chapter 13: Simulation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial packages required</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="simulation" class="level1">
<h1>Simulation</h1>
<p>Simulation (or as MDSR calls it “making up data”) is reasoning in reverse. Rather than start with data and then visualize and analyze to gain understanding, we will start with speculation and create data that fits that speculation. The simulated data then provides insights into our speculated system, and it can also be held up to real data to help us better understand that data.</p>
<p>We will look at several scenarios in which simulation can be valuable and tools that will help us generate useful simulated data.</p>
<section id="simulating-behavior-under-a-null-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="simulating-behavior-under-a-null-hypothesis">Simulating behavior under a null hypothesis</h2>
<p>While MDSR Section 13.2 has a cool example involving cancer genomics, we will consider a simpler example here.</p>
<p><a href="https://www.rossmanchance.com/applets/2021/chisqshuffle/ChiSqShuffle.htm?dolphins=1">This applet</a> contains data from a 2005 study on the use of dolphin-facilitated therapy on the treatment of depression. In that study, 10 of the 15 subjects (67%) assigned to dolphin therapy showed improvement, compared to only 3 of the 15 subjects (20%) assigned to the control group. But with such small sample sizes, is this significant evidence that the dolphin group had greater improvement of their depressive symptoms? To answer that question, we can use simulation to conduct a randomization test.</p>
<p>We will simulate behavior in the “null world” where there is no real effect of treatment. In that case, the 13 total improvers would have improved no matter the treatment assigned, and the 17 total non-improvers would have not improved no matter the treatment assigned. So in the “null world”, treatment is a meaningless label that can be just as easily shuffled among subjects without any effect. In that world, the fact we observed a 47 percentage point difference in success rates (67 - 20) was just random luck. But we should ask: how often would we expect a difference as large as 47% by chance, assuming we’re living in the null world where there is no effect of treatment?</p>
<p>You could think about simulating this situation with the following steps:</p>
<ol type="1">
<li><p>write code to calculate the difference in success rates in the observed data</p></li>
<li><p>write a loop to calculate the differences in success rates from 1000 simulated data sets from the null world. Store those 1000 simulated differences</p></li>
<li><p>calculate how often we found a difference in the null world as large as that found in the observed data. In statistics, when this probability is below .05, we typically reject the null world, and conclude that there is likely a real difference between the two groups (i.e.&nbsp;a “statistically significant” difference)</p></li>
</ol>
<section id="on-your-own" class="level3">
<h3 class="anchored" data-anchor-id="on-your-own">On Your Own</h3>
<ol type="1">
<li>Follow the steps above to conduct a <strong>randomization test for the difference in two proportions</strong>. In addition to finding your probability in (3), plot the 1000 simulated differences and indicate where the observed difference of .47 falls in that “null distribution”.</li>
</ol>
<p>The code below generates a tibble with our observed data. Notice how the <code>sample()</code> function can be used to shuffle the treatments among the 30 subjects.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dolphin_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">treatment =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Dolphin"</span>, <span class="st">"Control"</span>), <span class="at">each =</span> <span class="dv">15</span>),</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">improve =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="dv">10</span>), <span class="fu">rep</span>(<span class="st">"No"</span>, <span class="dv">5</span>), </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">rep</span>(<span class="st">"Yes"</span>, <span class="dv">3</span>), <span class="fu">rep</span>(<span class="st">"No"</span>, <span class="dv">12</span>)))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dolphin_data, <span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 2
   treatment improve
   &lt;chr&gt;     &lt;chr&gt;  
 1 Dolphin   Yes    
 2 Dolphin   Yes    
 3 Dolphin   Yes    
 4 Dolphin   Yes    
 5 Dolphin   Yes    
 6 Dolphin   Yes    
 7 Dolphin   Yes    
 8 Dolphin   Yes    
 9 Dolphin   Yes    
10 Dolphin   Yes    
11 Dolphin   No     
12 Dolphin   No     
13 Dolphin   No     
14 Dolphin   No     
15 Dolphin   No     
16 Control   Yes    
17 Control   Yes    
18 Control   Yes    
19 Control   No     
20 Control   No     
21 Control   No     
22 Control   No     
23 Control   No     
24 Control   No     
25 Control   No     
26 Control   No     
27 Control   No     
28 Control   No     
29 Control   No     
30 Control   No     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span>(dolphin_data<span class="sc">$</span>treatment)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Dolphin" "Dolphin" "Control" "Control" "Dolphin" "Dolphin" "Control"
 [8] "Dolphin" "Dolphin" "Control" "Control" "Dolphin" "Control" "Control"
[15] "Dolphin" "Dolphin" "Dolphin" "Control" "Dolphin" "Control" "Dolphin"
[22] "Control" "Dolphin" "Control" "Dolphin" "Control" "Control" "Control"
[29] "Dolphin" "Control"</code></pre>
</div>
</div>
</section>
</section>
<section id="evaluate-conditions-for-a-statistical-test" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-conditions-for-a-statistical-test">Evaluate conditions for a statistical test</h2>
<p>Most statistical tests rely on underlying mathematical conditions so that p-values, confidence intervals, and prediction intervals are valid. It’s important to know how robust tests are to these conditions - will they still perform well even with small or medium sized violations of the conditions?</p>
<p>Here we will focus on the two-sample t-test, which tests whether or not two independent groups have a significant difference in their means. The key mathematical conditions for this test are:</p>
<ul>
<li>independence between and within groups</li>
<li>data is normally distributed within each group</li>
<li>data has equal spread within each group (this condition is relaxed when we use the Welch approximation)</li>
</ul>
<p>And, how important these conditions are can further depend on:</p>
<ul>
<li>actual and relative sample sizes within each group</li>
<li>actual and relative spreads within each group</li>
<li>actual and relative shape of data within each group</li>
</ul>
<p>Let’s set up a simulation to generate responses from two independent groups, and then we’ll see how certain conditions might affect our ability to test mean differences between those groups.</p>
<p>We will need to use <strong>randomizing functions</strong>: functions in R that generate random values from specific probability distributions. We will always have to specify <em>parameters</em> for the distribution, since each distribution family can take on different shapes depending on the parameter settings. For instance, normal distributions are defined by their mean and standard deviation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rnorm() produces random values from a normal distribution</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>normal_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">mean =</span> <span class="dv">100</span>, <span class="at">sd =</span> <span class="dv">20</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>normal_data <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sd</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   mean    sd
  &lt;dbl&gt; &lt;dbl&gt;
1  99.7  20.4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(normal_data, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_simulation_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rexp() produces random values from an exponential distribution</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>exp_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">rexp</span>(<span class="dv">1000</span>, <span class="at">rate =</span> .<span class="dv">1</span>))    <span class="co"># mean = sd = 1 / rate</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>exp_data <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(x),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> <span class="fu">sd</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
   mean    sd
  &lt;dbl&gt; &lt;dbl&gt;
1  10.2  10.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(exp_data, <span class="fu">aes</span>(<span class="at">x =</span> x)) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_simulation_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># help("Distributions") for other shapes</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a simulation to examine the coverage of 95% confidence intervals. When we find a 95% confidence interval for the true difference between two means, mathematical theory tells us that our interval should be “correct” 95% of the time. That is, in 95% of repeated applications (or samplings), the reported confidence intervals should contain the true mean difference from the entire population of interest. That’s pretty powerful stuff! But if conditions are violated, are we still justified in declaring 95% confidence in our results?</p>
<p>Often we set <code>var.equal = FALSE</code> to use the Welch approximation which doesn’t require equal spread in the two groups (that’s actually the default in <code>t.test()</code>) but mathematical theory (and extensions to the ANOVA F-test) actually is based on equal variances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initial settings</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mean1 <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>mean2 <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>truediff <span class="ot">&lt;-</span> mean1 <span class="sc">-</span> mean2</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>sd2 <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>sd_ratio <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>sd1 <span class="ot">&lt;-</span> sd_ratio <span class="sc">*</span> sd2</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>n2 <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>numsims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Try one sampling to see if 95% CI contains the truediff</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>samp1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n1, mean1, sd1)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>samp2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n2, mean2, sd2)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(<span class="at">x =</span> samp1, <span class="at">y =</span> samp2, <span class="at">var.equal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>lower <span class="ot">&lt;-</span> result<span class="sc">$</span>conf.int[<span class="dv">1</span>]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>lower</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -11.02172</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>upper <span class="ot">&lt;-</span> result<span class="sc">$</span>conf.int[<span class="dv">2</span>]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>upper</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.451933</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>contains_truediff <span class="ot">&lt;-</span> (lower <span class="sc">&lt;=</span> truediff <span class="sc">&amp;</span> upper <span class="sc">&gt;=</span> truediff)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>contains_truediff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the sampling above</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">response =</span> <span class="fu">c</span>(samp1, samp2), </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">group =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Group 1"</span>, n1), <span class="fu">rep</span>(<span class="st">"Group 2"</span>, n2)))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>mosaic<span class="sc">::</span><span class="fu">favstats</span>(response <span class="sc">~</span> group, <span class="at">data =</span> sim_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'mosaic':
  method                           from   
  fortify.SpatialPolygonsDataFrame ggplot2</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>    group      min       Q1   median       Q3      max     mean       sd   n
1 Group 1 15.75192 33.13944 35.23895 40.22701 52.95265 34.92081 11.10507  10
2 Group 2 12.90567 32.02120 37.89980 47.22703 63.22504 39.20571 10.16594 100
  missing
1       0
2       0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sim_data, <span class="fu">aes</span>(<span class="at">x =</span> response, <span class="at">y =</span> group)) <span class="sc">+</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="07_simulation_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now repeat 1000 times!</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>contains_truediff <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"logical"</span>, numsims)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>numsims) {</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  samp1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n1, mean1, sd1)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  samp2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n2, mean2, sd2)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">t.test</span>(<span class="at">x =</span> samp1, <span class="at">y =</span> samp2, <span class="at">var.equal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  lower <span class="ot">&lt;-</span> result<span class="sc">$</span>conf.int[<span class="dv">1</span>]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  upper <span class="ot">&lt;-</span> result<span class="sc">$</span>conf.int[<span class="dv">2</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  contains_truediff[i] <span class="ot">&lt;-</span> (lower <span class="sc">&lt;=</span> truediff <span class="sc">&amp;</span> upper <span class="sc">&gt;=</span> truediff)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>coverage <span class="ot">&lt;-</span> <span class="fu">mean</span>(contains_truediff)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>coverage</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.944</code></pre>
</div>
</div>
<section id="on-your-own-1" class="level3">
<h3 class="anchored" data-anchor-id="on-your-own-1">On Your Own</h3>
<ol start="2" type="1">
<li><p>Use the simulation above to plot many different values of sd_ratio vs confidence interval coverage.</p></li>
<li><p>Adapt the simulation above to examine confidence interval width rather than confidence interval coverage.</p></li>
<li><p>Examine the effect of non-normal data. Does the effect change depending on the relative sample sizes in each group? Note that, if you use a distribution like <code>rgamma()</code> or <code>rexp()</code> the parameters are different, but we still want the mean to equal that in the normal distribution.</p></li>
</ol>
</section>
</section>
<section id="find-the-power-of-a-statistical-test" class="level2">
<h2 class="anchored" data-anchor-id="find-the-power-of-a-statistical-test">Find the power of a statistical test</h2>
<p>The <strong>power</strong> of a statistical test is the probability that it rejects the null hypothesis when the null hypothesis is false. In other words, it’s the probability that a statistical test can detect when a true difference exists. The power depends on a number of factors, including:</p>
<ul>
<li>sample size</li>
<li>type I error level</li>
<li>variability in the data</li>
<li>size of the true difference</li>
</ul>
<p>The following steps can be followed to simulate a power calculation</p>
<ol type="1">
<li><p>simulate data where is a true difference or effect</p></li>
<li><p>run your desired test on the simulated data and record if the null hypothesis was rejected or not (i.e.&nbsp;if the p-value was below .05)</p></li>
<li><p>repeat a large number of times and record the total proportion of times that the null hypothesis was rejected - that is the power of the test under those conditions</p></li>
<li><p>often we will then repeat (1)-(3) under different conditions - different sizes of the true effect, different amount of variability, different sample sizes, etc.</p></li>
</ol>
<section id="on-your-own-2" class="level3">
<h3 class="anchored" data-anchor-id="on-your-own-2">On Your Own</h3>
<ol start="5" type="1">
<li>Here is a real email I received from a real research physician. My response was formed after running several simulations…</li>
</ol>
<blockquote class="blockquote">
<p>Do you mind if I ask for some statistical guidance? This is probably a pretty straightforward question but I’m struggling with it a bit.</p>
</blockquote>
<blockquote class="blockquote">
<p>One of our docs wants to conduct a study looking at a biomarker called PARP. The hypothesis is that expression of PARP is correlated with decreased survival in breast cancer. The test will be done on archived tissue and will be read as either positive or negative. The hypothesis is that patients who overexpress PARP will have a response rate to chemotherapy of 10% and that non-expressers will have a response rate of 25%.</p>
</blockquote>
<blockquote class="blockquote">
<p>The proposed patient population is 220 patients. This is the power analysis:</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size for Response Rate (2-sample comparison, 1-sided, alpha=0.05)</p>
</blockquote>
<blockquote class="blockquote">
<p>Power = 80</p>
</blockquote>
<blockquote class="blockquote">
<p>Null Hypothesis (H0) = .05 (Response Rate for Overexpression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Alternative Hypothesis (H1) = .25 (Response Rate for Normal Expression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (STPlan) = 35</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (nQuery) = 39</p>
</blockquote>
<blockquote class="blockquote">
<p>Power = 85</p>
</blockquote>
<blockquote class="blockquote">
<p>Null Hypothesis (H0) = .05 (Response Rate for Overexpression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Alternative Hypothesis (H1) = .25 (Response Rate for Normal Expression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (STPlan) = 41</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (nQuery) = 45</p>
</blockquote>
<blockquote class="blockquote">
<p>Power = 80</p>
</blockquote>
<blockquote class="blockquote">
<p>Null Hypothesis (H0) = .10 (Response Rate for Overexpression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Alternative Hypothesis (H1) = .25 (Response Rate for Normal Expression Group)</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (STPlan) = 76</p>
</blockquote>
<blockquote class="blockquote">
<p>Sample Size per Group (nQuery) = 79</p>
</blockquote>
<blockquote class="blockquote">
<p>etc. (Many more runs of their power software with different levels of power and different assumptions about HO and H1)</p>
</blockquote>
<blockquote class="blockquote">
<p>Now the unknown variable is what proportion of tumors will express PARP. From looking at this it appears that he is assuming that the sample size will be equal in each group but in fact, it appears that PARP expression may be present in 80-90% of tumors. Let’s assume that 80% of tumors are expressers and 20% are non-expressers. I’m not crazy in assuming that will have a significant impact on our needed study size to show a p value of 0.05 at 80% power with the above assumptions, am I?</p>
</blockquote>
<p>Provide a plot (ideally) or table to answer this physician’s question. Your plot should be based on several simulated power calculations under different assumptions about (a) the percentage of PARP expressers, and (b) the true response rates in both groups.</p>
<p>Note that <code>rbinom(1, size = N, prob = P)</code> will simulate the number of responders in a group with N subjects who each have probability P of responding.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© Paul Roback, 2024<br> All content licensed under <img src="https://static.thenounproject.com/png/70967-200.png" height="20"> (<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>)</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Site built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



</body></html>