---
title: "Section 3.2.3 from Modern Data Science with R"
subtitle: "Creating informative maps"
output:
  pdf_document:
    fig_height: 3
    fig_width: 4.5
  html_document: default
  word_document: default
editor_options: 
  chunk_output_type: console
---

```{r, setup, include = FALSE}
# Initial packages required (we'll be adding more)
library(tidyverse)
library(mdsr)      # package associated with our MDSR book
```

### Opening example: choropleth map

Here is a simple example from MDSR 

```{r}
# CIACountries is a 236 x 8 data set with information on each country
#   taken from the CIA factbook - things like gdp, education, internet use, etc.
CIACountries |>
  select(country, oil_prod) |>
  mutate(oil_prod_disc = cut(oil_prod, 
                             breaks = c(0, 1e3, 1e5, 1e6, 1e7, 1e8), 
                             labels = c(">1000", ">10,000", ">100,000", ">1 million", ">10 million"))) |>
  mosaic::mWorldMap(key = "country") +
  geom_polygon(aes(fill = oil_prod_disc)) + 
  scale_fill_brewer("Oil Prod. (bbl/day)", na.value = "white") +
  theme(legend.position = "top")

```

```{r, include=FALSE}
airbnb.df <- read_csv("~/Mscs 264 S24/Class/Data/airbnbData_full.csv")
```

## Interactive map with leaflet

```{r, message= FALSE}
library(leaflet)
```

With leaflet, you can have "pop-up" messages when you hover over points, and have a zoom-in and zoom-out option. 

Two main features:
   addTiles()   Add background map
   setView()    Set where the map should originally zoom to
   
```{r}
# This part is for the pop-up messages.... some are weird or just "\n"
# for example, so this turns the weird stuff to blanks. 
# We could also probably do this with str_ functions.
Encoding( x = airbnb.df$AboutListing ) <- "UTF-8"
airbnb.df$AboutListing <-
  iconv( x = airbnb.df$AboutListing
         , from = "UTF-8"
         , to = "UTF-8"
         , sub = "" )

# This part makes the map!
leaflet() %>%
    addTiles() %>% 
    setView(lng = mean(airbnb.df$Long), lat = mean(airbnb.df$Lat), 
            zoom = 13) %>% 
    addCircleMarkers(data = airbnb.df,
        lat = ~ Lat, 
        lng = ~ Long, 
        popup = ~ AboutListing, 
        radius = ~ S_Accomodates,  
        # These last options describe how the circles look
        weight = 2,
        color = "red", 
        fillColor = "yellow")
```

### Choropleth Maps

When you have specific regions (e.g. countries, states, counties, census tracts,...) and a value associated with each region. 

A choropleth map will color the entire region according to the value. 
For example, let's consider state vaccination data from March 2021.

```{r}
vaccine_data <- read_csv("~/Mscs 264 S24/Class/Data/vacc_Mar21.csv") 

vacc_mar13 <- vaccine_data %>%
  filter(Date =="2021-03-13") %>%
  select(State, Date, people_vaccinated_per100, share_doses_used, Governor)

vacc_mar13
```

The tricky part of choropleth maps is getting the shapes (polygons) that make up the regions. This is really a pretty complex set of lines for R to draw! 

Luckily, some maps are already created in R in the maps package.

```{r}
library(maps)
us_states <- map_data("state")
head(us_states)
# Note that points in the same "group" are connected with a line

us_states %>%
  ggplot(mapping = aes(x = long, y = lat,
                          group = group)) + 
  geom_polygon(fill = "white", color = "black")
```

Other maps provided by the `maps` package include US counties, France, Italy, New Zealand, and two different views of the world. If you want maps of other countries or regions, you can often find them online.

Sometimes maps may be provided as shapefiles. To use these, you'll first need to read them into R and then turn them into tidy dataframes in order to use them with ggplot. See here: https://www.r-graph-gallery.com/168-load-a-shape-file-into-r.html.  More on shapefiles in Part 2.

Where the really cool stuff happens is when we join our data to the us_states dataframe.  Notice that the state name appears in the "region" column of us_states, and that the state name is in all small letters. In `vacc_mar13`, the state name appears in the State column and is in title case.

Run this line by line to see what it does:

```{r}
vacc_mar13 <- vacc_mar13 %>%
  mutate(State = str_to_lower(State))

vacc_mar13 %>%
  right_join(us_states, by = c("State" = "region")) %>%
  rename(region = State) %>%
  ggplot(mapping = aes(x = long, y = lat,
                          group = group)) + 
  geom_polygon(aes(fill = people_vaccinated_per100), color = "black")
```

oops, New York appears to be a problem.

```{r}
vacc_mar13 %>%
  anti_join(us_states, by = c("State" = "region"))

us_states %>%
  anti_join(vacc_mar13, by = c("region" = "State")) %>%
  count(region)
```

The state of New York is called "new york state" in the vaccines data, but is called "new york" in the us_states dataset. That's why we always check with `anti_join`!! Notice that the us_states map also includes only the contiguous 48 states. This gives an example of creating really beautiful map insets for Alaska and Hawaii: https://r-spatial.org/r/2018/10/25/ggplot2-sf-3.html

```{r}
vacc_mar13 <- vacc_mar13 %>%
  mutate(State = str_replace(State, " state", ""))

vacc_mar13 %>%
  anti_join(us_states, by = c("State" = "region"))

us_states %>%
  anti_join(vacc_mar13, by = c("region" = "State")) %>%
  count(region)
```

Better.


```{r}
library(viridis) # for color schemes
vacc_mar13 %>%
  right_join(us_states, by = c("State" = "region")) %>%
  rename(region = State) %>%
  ggplot(mapping = aes(x = long, y = lat,
                          group = group)) + 
  geom_polygon(aes(fill = people_vaccinated_per100), color = "black") + 
  labs(fill = "People Vaccinated\nper 100 pop.") +
  # This scales the longitude and latitude so that the shapes look correct.
  coord_map() + 
  # This theme can give you a really clean look!
  theme_void() +  
  # you can change the fill scale for different color schemes.
  scale_fill_viridis() 
```

Note: Map projections are actually pretty complicated, especially if you're looking at large areas (e.g. world maps).  It's impossible to preserve both shape and area when projecting a sphere onto a flat surface, so that's why you sometimes see such different maps of the world (for example: https://futuremaps.com/blogs/news/top-10-world-map-projections)

There are a few different options in coord_map(). See the help menu.

You can also use a categorical variable to color regions:

```{r}
vacc_mar13 %>%
  right_join(us_states, by = c("State" = "region")) %>%
  rename(region = State) %>%
  ggplot(mapping = aes(x = long, y = lat,
                          group = group)) + 
  geom_polygon(aes(fill = Governor), color = "darkgrey", size = 0.2) + 
  labs(fill = "Governor") +
  # This scales the longitude and latitude so that the shapes look correct.
  coord_map() + 
  # This theme can give you a really clean look!
  theme_void() +  
  # you can change the fill scale for different color schemes.
  scale_fill_manual(values = c("blue", "red")) 
```

Multiple maps:

```{r}
library(lubridate)
weekly_vacc <- vaccine_data %>%
  mutate(State = str_to_lower(State)) %>%
  mutate(State = str_replace(State, " state", ""),
         week = week(Date)) %>%
  group_by(week, State) %>%
  summarize(date = first(Date),
            mean_daily_vacc = mean(daily_vaccinated/est_population*1000))%>%
  right_join(us_states, by =c("State" = "region")) %>%
  rename(region = State)

weekly_vacc %>%
  filter(week > 2, week < 11) %>%
  ggplot(mapping = aes(x = long, y = lat,
                          group = group)) + 
  geom_polygon(aes(fill = mean_daily_vacc), color = "darkgrey", size = 0.1) + 
  labs(fill = "Weekly Average Daily Vaccinations per 1000") +
  coord_map() + 
  theme_void() + 
  scale_fill_viridis() + 
  facet_wrap(~date) + 
  theme(legend.position = "bottom") 
```

### Other cool state maps

#### statebin (square representation of states)

One downside of choropleth maps (particularly of the US states) is that region size does not correspond to the number of people. If you want to de-emphasize geographic area, you can use a map like the one below, which makes all the states into squares labeled with their abbreviation:

```{r}
library(statebins) # may need to install

vacc_mar13 %>%
  mutate(State = str_to_title(State)) %>%
  statebins(state_col = "State",
            value_col = "people_vaccinated_per100") + 
  # one nice layout. You can customize with usual ggplot themes.
  theme_statebins() + 
  labs(fill = "People Vaccinated per 100")
```


I used the examples below to create this code:

https://livefreeordichotomize.com/2021/04/07/nytimes-map-how-to/

Original graph here: https://www.nytimes.com/interactive/2021/04/06/us/variants-cases-spread.html


### On Your Own

```{r}
# 135 variables on each of the 50 US states
# For more detail, see: https://rdrr.io/cran/poliscidata/man/states.html

library(poliscidata)   # may have to install first
state_data <- as_tibble(poliscidata::states)
print(state_data, n = 5, width = Inf)

# Want to merge with us_states geographic info
us_states <- as_tibble(us_states)
print(us_states, n = 5, width = Inf)

state_plotting <- state_data |>
  mutate(state_name = str_squish(str_to_lower(as.character(state)))) |>
  select(-state) |>
  right_join(us_states, by = c("state_name" = "region"))
print(state_plotting, n = 5, width = Inf)

state_plotting |>
  ggplot(mapping = aes(x = long, y = lat, group = group)) + 
    geom_polygon(aes(fill = carfatal07), color = "black") + 
    labs(fill = "2007 car fatalities") +
    coord_map() + 
    theme_void() +  
    scale_fill_viridis() 

```

